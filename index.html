<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WhatsAI</title>
    <!-- Favicon - Verde con burbuja de chat blanca (más fiel a WhatsApp) -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='20' ry='20' fill='%2325D366'/%3E%3Cpath d='M75 25c-1.5-1.5-3.5-2.5-5.5-2.5h-40c-2 0-4 1-5.5 2.5-1.5 1.5-2.5 3.5-2.5 5.5v30c0 2 1 4 2.5 5.5l10 10v-10h38c2 0 4-1 5.5-2.5 1.5-1.5 2.5-3.5 2.5-5.5v-30c0-2-1-4-2.5-5.5z' fill='%23FFFFFF'/%3E%3C/svg%3E">
    <!-- Importa Font Awesome para los iconos -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Enlaza la fuente Inter desde Google Fonts (se mantiene por si acaso, pero la pila de fuentes la anula si hay mejores) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Variables CSS para colores - Modo Oscuro (por defecto) */
        :root {
            --bg-dark: #0A1014; /* Fondo principal oscuro (más oscuro, casi negro) */
            --bg-light-dark: #1E252B; /* Fondo de la barra lateral y cabeceras oscuro */
            --bg-chat-area: #0B141A; /* Fondo del área de chat principal oscuro (patrón de chat de WhatsApp) */
            --text-primary: #E9EDEF; /* Color de texto principal */
            --text-secondary: #8696A0; /* Color de texto secundario/gris */
            --green-primary: #00A884; /* Verde principal de WhatsApp */
            --green-secondary: #008069; /* Verde más oscuro para algunos elementos (ej. hover de botones) */
            --bubble-received: #202C33; /* Burbuja de mensaje recibido */
            --bubble-sent: #005C4B; /* Burbuja de mensaje enviado */
            --input-bg: #2A3942; /* Fondo del campo de entrada */
            --border-color: #2F3B44; /* Color del borde entre secciones */
            --icon-color: #AEB3B7; /* Color de los iconos */
            --hover-bg: #32404A; /* Color de fondo al pasar el ratón */
            --modal-bg: #1F2C34; /* Fondo del modal */
            --modal-overlay: rgba(0, 0, 0, 0.7); /* Fondo oscuro del overlay del modal */
            --dropdown-bg: #2A3942; /* Fondo del menú desplegable */
            --dropdown-hover: #32404A; /* Hover del menú desplegable */
        }

        /* Variables CSS para colores - Modo Claro */
        body.light-mode {
            --bg-dark: #F0F2F5; /* Fondo principal claro (fondo de la lista de chats, ligeramente diferente) */
            --bg-light-dark: #FFFFFF; /* Fondo de la barra lateral y cabeceras claro */
            --bg-chat-area: #EAE6DF; /* Fondo del área de chat principal claro (WhatsApp chat background claro) */
            --text-primary: #3B4A54; /* Color de texto principal gris oscuro */
            --text-secondary: #667781; /* Color de texto secundario/gris oscuro */
            --green-primary: #00A884; /* Verde principal de WhatsApp */
            --green-secondary: #075E54; /* Verde más oscuro para algunos elementos */
            --bubble-received: #FFFFFF; /* Burbuja de mensaje recibido blanca */
            --bubble-sent: #D9FDD3; /* Burbuja de mensaje enviado verde claro */
            --input-bg: #FFFFFF; /* Fondo del campo de entrada blanco */
            --border-color: #E2E4E7; /* Color del borde entre secciones claro (más sutil) */
            --icon-color: #667781; /* Color de los iconos oscuro */
            --hover-bg: #F5F5F5; /* Color de fondo al pasar el ratón claro */
            --modal-bg: #FFFFFF; /* Fondo del modal blanco */
            --modal-overlay: rgba(0, 0, 0, 0.5); /* Fondo oscuro del overlay del modal (se mantiene para contraste) */
            --dropdown-bg: #FFFFFF; /* Fondo del menú desplegable blanco */
            --dropdown-hover: #F5F5F5; /* Hover del menú desplegable claro */
        }

        /* Reset básico y estilos generales */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            /* Nueva pila de fuentes para una estética más similar a WhatsApp */
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow: hidden; /* Evita el scroll global */
            display: flex; /* Para organizar el contenedor principal */
            flex-direction: column;
        }

        .whatsapp-container {
            display: flex;
            height: 100vh; /* Ocupa el 100% de la altura del viewport */
            width: 100vw; /* Ocupa el 100% del ancho del viewport */
            background-color: var(--bg-light-dark);
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
        }

        /* Estilos del panel izquierdo (sidebar) */
        .sidebar {
            flex: 0 0 25%; /* Reducido a 25% del ancho para web */
            max-width: 320px; /* Ancho máximo para el sidebar en web */
            background-color: var(--bg-light-dark);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: relative; /* Necesario para el botón flotante */
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background-color: var(--bg-light-dark);
            border-bottom: 1px solid var(--border-color);
            position: relative; /* Para posicionar el dropdown del header */
            height: 60px; /* Altura fija para alineación */
        }

        .sidebar-header .profile-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .sidebar-header .profile-pic-display {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #ccc; /* Placeholder */
            overflow: hidden;
            flex-shrink: 0; /* Evita que la imagen se encoja */
        }

        .sidebar-header .profile-pic-display img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .sidebar-header .username-info {
            display: flex;
            flex-direction: column;
        }

        .sidebar-header .username-display {
            font-weight: 500;
            font-size: 16px;
            color: var(--text-primary);
            max-width: 150px; /* Limitar ancho para el nombre */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-header .user-status-display {
            font-size: 12px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }

        .sidebar-header .icons {
            position: relative; /* Para el posicionamiento del dropdown */
            display: flex;
            gap: 20px;
        }

        .sidebar-header .icons i {
            font-size: 20px;
            color: var(--icon-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .sidebar-header .icons i:hover {
            background-color: var(--hover-bg);
        }

        /* Menú desplegable del header del sidebar */
        .header-dropdown-menu {
            position: absolute;
            top: 50px; /* Ajusta la posición vertical */
            right: 10px;
            background-color: var(--dropdown-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            min-width: 180px;
            z-index: 30; /* Asegura que esté por encima de otros dropdowns */
            overflow: hidden;
        }

        .header-dropdown-menu.hidden {
            display: none;
        }

        .header-dropdown-menu .dropdown-item {
            padding: 12px 20px; /* Más padding para más margen */
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .header-dropdown-menu .dropdown-item:hover {
            background-color: var(--green-secondary); /* Cambia a un tono verde en hover */
        }


        .chat-list {
            flex-grow: 1;
            overflow-y: auto;
            background-color: var(--bg-dark); /* Fondo de la lista de chats */
        }

        /* Estilos de un elemento de chat en la lista */
        .chat-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.2s ease;
            position: relative; /* Para posicionar el icono de menú del chat */
        }

        .chat-item:hover {
            background-color: var(--hover-bg);
        }

        .chat-item.active {
            background-color: var(--hover-bg); /* Resalta el chat activo */
        }

        .chat-item .profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: #ccc; /* Placeholder */
            object-fit: cover;
            margin-right: 15px;
        }

        /* Estilo para la imagen de perfil con letra aleatoria */
        .profile-pic.placeholder {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: bold;
            color: white; /* Color de la letra */
            text-transform: uppercase;
        }

        .chat-item .chat-info {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-item .chat-info .name {
            font-weight: 500;
            font-size: 16px;
            margin-bottom: 2px;
        }

        .chat-item .chat-info .last-message {
            font-size: 14px;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-item .chat-time {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 10px;
            white-space: nowrap;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
        }

        /* Badge de mensajes no leídos */
        .chat-item .unread-badge {
            background-color: var(--green-primary);
            color: white;
            font-size: 10px;
            font-weight: bold;
            border-radius: 50%;
            min-width: 20px; /* Usar min-width para que el número quepa */
            height: 20px;
            padding: 0 6px; /* Añadir padding horizontal para números de dos dígitos */
            display: flex;
            justify-content: center;
            align-items: center;
            margin-left: auto; /* Empuja a la derecha */
            margin-top: 5px; /* Pequeño margen superior para separarlo del tiempo */
        }

        /* Icono de menú de 3 puntos en el chat item */
        .chat-item .chat-menu-icon {
            font-size: 18px;
            color: var(--icon-color);
            margin-left: 10px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
            opacity: 0; /* Oculto por defecto */
            visibility: hidden; /* Oculto por defecto */
            transition: opacity 0.2s ease, visibility 0.2s ease;
        }

        .chat-item:hover .chat-menu-icon {
            opacity: 1; /* Visible al pasar el ratón */
            visibility: visible; /* Visible al pasar el ratón */
        }

        .chat-item .chat-menu-icon:hover {
            background-color: var(--hover-bg);
        }

        /* Menú desplegable del chat item */
        .chat-dropdown-menu {
            position: absolute;
            top: 50px; /* Ajusta la posición vertical según sea necesario */
            right: 10px;
            background-color: var(--dropdown-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            min-width: 150px;
            z-index: 20; /* Asegura que esté por encima de otros elementos */
            overflow: hidden; /* Para que los bordes redondeados funcionen bien con los items */
            display: none; /* Oculto por defecto */
        }

        .chat-dropdown-menu.visible {
            display: block;
        }

        .chat-dropdown-menu .dropdown-item {
            padding: 10px 15px;
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .chat-dropdown-menu .dropdown-item:hover {
            background-color: var(--dropdown-hover);
        }

        .chat-dropdown-menu .dropdown-item.delete-option {
            color: #ff4d4d; /* Color rojo para la opción de borrar */
        }


        /* Estilos del área de chat principal (main-chat) */
        .main-chat {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background-color: var(--bg-chat-area);
        }

        .main-chat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 16px;
            background-color: var(--bg-light-dark);
            border-bottom: 1px solid var(--border-color);
            height: 60px; /* Altura fija para alineación */
            position: relative; /* Para el dropdown del header del chat */
        }

        .main-chat-header .contact-info {
            display: flex;
            align-items: center;
            gap: 15px; /* Añadido para espaciar el nombre del borde si no hay foto */
            cursor: pointer; /* Hacer clickeable el área de info del contacto */
        }

        /* Estilo para la imagen de perfil en el header del chat principal */
        .main-chat-header .contact-info .profile-pic-header {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: -5px; /* Ajuste para acercar al nombre */
            flex-shrink: 0;
        }

        .main-chat-header .contact-info .name {
            font-weight: 500;
            font-size: 16px;
        }

        .main-chat-header .contact-info .status {
            font-size: 12px;
            color: var(--text-secondary);
        }

        /* Estado "escribiendo..." */
        .main-chat-header .contact-info .status.typing {
            color: var(--green-primary); /* Verde para "escribiendo" */
        }

        .main-chat-header .icons {
            position: relative; /* Para el posicionamiento del dropdown */
            display: flex;
            gap: 20px;
        }

        .main-chat-header .icons i {
            font-size: 20px;
            color: var(--icon-color);
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .main-chat-header .icons i:hover {
            background-color: var(--hover-bg);
        }

        /* Botón de retroceso para móvil */
        .main-chat-header .back-button {
            font-size: 22px;
            color: var(--icon-color);
            cursor: pointer;
            margin-right: 15px;
            display: none; /* Oculto por defecto, visible en móvil */
        }

        /* Menú desplegable del header del chat principal */
        .main-chat-header .chat-header-dropdown-menu {
            position: absolute;
            top: 50px; /* Ajusta la posición vertical */
            right: 10px;
            background-color: var(--dropdown-bg);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            min-width: 180px;
            z-index: 30; /* Asegura que esté por encima de otros dropdowns */
            overflow: hidden;
        }

        .main-chat-header .chat-header-dropdown-menu.hidden {
            display: none;
        }

        .main-chat-header .chat-header-dropdown-menu .dropdown-item {
            padding: 12px 20px; /* Más padding para más margen */
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .main-chat-header .chat-header-dropdown-menu .dropdown-item:hover {
            background-color: var(--green-secondary); /* Cambia a un tono verde en hover */
        }


        .message-area {
            flex-grow: 1;
            padding: 10px 20px; /* Márgenes laterales reducidos */
            overflow-y: auto;
            background-color: var(--bg-chat-area); /* Asegura el color de fondo del área de chat */
            display: flex;
            flex-direction: column;
            gap: 10px; /* Espacio entre burbujas ampliado */
        }

        .message-area::-webkit-scrollbar {
            width: 6px;
        }

        .message-area::-webkit-scrollbar-thumb {
            background-color: #555;
            border-radius: 10px;
        }

        .message-area::-webkit-scrollbar-track {
            background-color: transparent;
        }

        .message-date-divider {
            text-align: center;
            margin: 15px 0;
        }

        .message-date-divider span {
            background-color: var(--bg-light-dark);
            color: var(--text-secondary);
            font-size: 12px;
            padding: 5px 10px;
            border-radius: 8px;
        }

        .message-bubble {
            max-width: 65%; /* Ancho máximo de la burbuja */
            padding: 6px 8px; /* Reducido el padding interno */
            border-radius: 8px;
            position: relative;
            word-wrap: break-word; /* Permite que el texto se ajuste */
            display: flex;
            flex-direction: column;
            line-height: 1.2; /* Ajustado el interlineado */
        }

        .message-bubble.received {
            background-color: var(--bubble-received);
            align-self: flex-start;
            border-bottom-left-radius: 2px; /* Esquina inferior izquierda menos redondeada */
        }

        .message-bubble.sent {
            background-color: var(--bubble-sent);
            align-self: flex-end;
            border-bottom-right-radius: 2px; /* Esquina inferior derecha menos redondeada */
        }

        .message-bubble .message-text {
            font-size: 15px;
            line-height: 1.3; /* Mantenido para el texto dentro de la burbuja */
            margin-bottom: 2px; /* Reducido el margen inferior del texto */
        }

        .message-bubble .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            align-self: flex-end;
            margin-left: auto; /* Empuja la hora a la derecha */
            display: flex; /* Para alinear la hora y las palomitas */
            align-items: center;
        }

        /* Message status ticks */
        .message-bubble .message-status {
            font-size: 11px;
            color: var(--text-secondary); /* Grey for sent/received */
            margin-left: 5px;
            transition: color 0.3s ease, text-shadow 0.3s ease; /* Transición suave para el color */
        }

        .message-bubble .message-status.read {
            color: #53BDEB; /* WhatsApp blue for read */
            text-shadow: 0 0 2px rgba(83, 189, 235, 0.5); /* Pequeño brillo para destacar */
        }

        /* Estilos para burbujas de imagen (se mantienen por si hay mensajes antiguos, pero no se generarán nuevos) */
        .image-bubble {
            background-color: var(--bubble-sent); /* O var(--bubble-received) */
            padding: 8px;
            border-radius: 8px;
            max-width: 65%;
            display: flex;
            flex-direction: column;
            align-self: flex-end; /* Por defecto enviado */
        }

        .image-bubble.received {
            background-color: var(--bubble-received);
            align-self: flex-start;
        }

        .image-bubble img {
            max-width: 200px; /* Tamaño máximo para la imagen */
            max-height: 200px; /* Tamaño máximo para la imagen */
            width: auto; /* Permite que la imagen se ajuste al max-width */
            height: auto; /* Permite que la imagen se ajuste al max-height */
            object-fit: contain; /* Asegura que la imagen se contenga dentro de las dimensiones sin recortarse */
            border-radius: 6px;
            margin-bottom: 5px;
        }

        .image-bubble .message-text {
            font-size: 15px;
            line-height: 1.3;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .image-bubble .message-time {
            font-size: 11px;
            color: var(--text-secondary);
            align-self: flex-end;
            margin-left: auto;
        }


        .main-chat-footer {
            display: flex;
            align-items: flex-end; /* Alineado a la parte inferior para que el textarea crezca hacia arriba */
            padding: 10px 16px;
            background-color: var(--bg-light-dark);
            border-top: 1px solid var(--border-color);
            gap: 10px;
        }

        .main-chat-footer .icons {
            display: flex;
            gap: 10px; /* Reducido el gap para los iconos */
            align-self: center; /* Centrar verticalmente los iconos */
            margin-bottom: 8px; /* Ajuste para alinear con el textarea */
        }

        .main-chat-footer .icons i {
            font-size: 22px;
            color: var(--icon-color);
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }

        .main-chat-footer .icons i:hover {
            background-color: var(--hover-bg);
        }

        .main-chat-footer .input-box {
            flex-grow: 1;
            background-color: var(--input-bg); /* Usar variable CSS para el fondo del input */
            border-radius: 22px; /* Bordes más redondos */
            padding: 8px 15px; /* Mantener el padding para la altura de la barra */
            display: flex;
            align-items: center; /* Alineación vertical para el contenido del input-box */
            min-height: 40px; /* Altura mínima para la barra de entrada */
        }

        .main-chat-footer .input-box textarea { /* Cambiado a textarea */
            flex-grow: 1;
            background: none; /* Asegurar que no tenga fondo propio para heredar del padre */
            border: none;
            outline: none;
            color: var(--text-primary);
            font-size: 15px;
            padding: 0; /* Eliminar padding interno del input para que el padding del .input-box lo controle */
            min-height: 24px; /* Altura mínima para una línea de texto */
            line-height: 24px; /* Asegura que el texto esté centrado verticalmente */
            resize: none; /* Deshabilita el redimensionamiento manual del usuario */
            overflow-y: hidden; /* Oculta la barra de desplazamiento hasta que sea necesaria */
            max-height: 120px; /* Altura máxima para la barra de texto (aprox. 5 líneas) */
        }

        .main-chat-footer .input-box textarea::placeholder { /* Cambiado a textarea */
            color: var(--text-secondary);
        }

        .main-chat-footer .input-box i {
            color: var(--icon-color);
            font-size: 20px;
            cursor: pointer;
        }

        .main-chat-footer .send-button {
            background-color: var(--green-primary);
            color: white;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            flex-shrink: 0; /* Evita que el botón se encoja */
        }

        .main-chat-footer .send-button:hover {
            background-color: var(--green-secondary);
        }

        /* Botón flotante para crear nuevo chat */
        .create-chat-button {
            position: absolute; /* Posición relativa al .sidebar */
            bottom: 20px;
            right: 20px;
            background-color: var(--green-primary);
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
            transition: background-color 0.2s ease, transform 0.2s ease;
            z-index: 10; /* Asegura que esté por encima de la lista de chats */
        }

        .create-chat-button:hover {
            background-color: var(--green-secondary);
            transform: translateY(-2px);
        }

        /* Pantalla de bienvenida / espera */
        .welcome-screen {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background-color: var(--bg-chat-area); /* Mismo color de fondo que el área de chat */
            color: var(--text-secondary);
            padding: 20px;
        }

        .welcome-screen .welcome-icon {
            font-size: 120px;
            color: #2e3b44; /* Un color más claro para el icono de fondo */
            margin-bottom: 20px;
        }

        .welcome-screen h2 {
            font-size: 28px;
            font-weight: 400;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .welcome-screen p {
            font-size: 14px;
            line-height: 1.5;
            max-width: 400px;
        }

        /* Clase de utilidad para ocultar elementos */
        .hidden {
            display: none !important;
        }

        /* Estilos del modal de nuevo chat y edición de perfil */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--modal-overlay);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100; /* Por encima de todo lo demás */
        }

        .new-chat-modal, .edit-profile-modal, .confirm-modal-content, .feature-coming-soon-modal, .cookie-consent-modal, .chat-details-modal {
            background-color: var(--modal-bg);
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
            width: 90%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            position: relative;
        }

        .new-chat-modal h3, .edit-profile-modal h3, .confirm-modal-content h3, .feature-coming-soon-modal h3, .cookie-consent-modal h3, .chat-details-modal h3 {
            color: var(--text-primary);
            font-size: 22px;
            margin-bottom: 10px;
            text-align: center;
        }

        .new-chat-modal .close-modal, .edit-profile-modal .close-modal, .confirm-modal-content .close-modal, .feature-coming-soon-modal .close-modal, .cookie-consent-modal .close-modal, .chat-details-modal .close-modal {
            position: absolute;
            top: 15px;
            right: 15px;
            font-size: 24px;
            color: var(--icon-color);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .new-chat-modal .close-modal:hover, .edit-profile-modal .close-modal:hover, .confirm-modal-content .close-modal:hover, .feature-coming-soon-modal .close-modal:hover, .cookie-consent-modal .close-modal:hover, .chat-details-modal .close-modal:hover {
            color: var(--text-primary);
        }

        .modal-field {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .modal-field label {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .modal-field input[type="text"],
        .modal-field textarea,
        .modal-field select { /* Estilo para el nuevo select */
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px 15px;
            color: var(--text-primary);
            font-size: 15px;
            outline: none;
            resize: vertical; /* Permite redimensionar verticalmente el textarea */
            appearance: none; /* Elimina estilos por defecto del select */
            -webkit-appearance: none;
            -moz-appearance: none;
            cursor: pointer;
        }

        .modal-field select {
            background-image: url('data:image/svg+xml;utf8,<svg fill="%238696a0" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/><path d="M0 0h24v24H0z" fill="none"/></svg>');
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 30px; /* Espacio para el icono */
        }


        .modal-field input[type="text"]::placeholder,
        .modal-field textarea::placeholder {
            color: var(--text-secondary);
        }

        .modal-field textarea {
            min-height: 80px;
            max-height: 200px;
        }

        .modal-profile-pic-upload {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background-color: #ccc;
            overflow: hidden;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            margin: 0 auto 20px auto; /* Centrar y añadir margen inferior */
            position: relative;
            border: 2px solid var(--border-color);
        }

        .modal-profile-pic-upload img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .modal-profile-pic-upload input[type="file"] {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .modal-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .modal-buttons .cancel-btn {
            background-color: var(--hover-bg);
            color: var(--text-primary);
        }

        .modal-buttons .cancel-btn:hover {
            background-color: #445460;
        }

        .modal-buttons .create-btn, .modal-buttons .accept-btn, .modal-buttons .send-btn {
            background-color: var(--green-primary);
            color: white;
        }

        .modal-buttons .create-btn:hover, .modal-buttons .accept-btn:hover, .modal-buttons .send-btn:hover {
            background-color: var(--green-secondary);
        }

        /* Estilos para la modal de confirmación de borrado */
        .confirm-modal-content {
            text-align: center;
        }

        .confirm-modal-content p {
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 20px;
        }

        .confirm-modal-content .modal-buttons {
            justify-content: center; /* Centrar los botones */
        }

        /* Estilos específicos para la modal de "Pronto disponible" */
        .feature-coming-soon-modal {
            text-align: center;
        }
        .feature-coming-soon-modal p {
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 20px;
        }
        .feature-coming-soon-modal .modal-buttons {
            justify-content: center;
        }

        /* Estilos para la modal de consentimiento de cookies */
        .cookie-consent-modal {
            text-align: center;
        }
        .cookie-consent-modal p {
            color: var(--text-secondary);
            font-size: 15px;
            margin-bottom: 20px;
        }
        .cookie-consent-modal .modal-buttons {
            justify-content: center;
        }

        /* Estilos para la modal de detalles del chat */
        .chat-details-modal .modal-profile-pic-display {
            width: 100px;
            height: 100px;
            margin-bottom: 15px;
        }
        .chat-details-modal p {
            text-align: left;
            color: var(--text-primary);
            margin-bottom: 10px;
            word-wrap: break-word; /* Asegura que el texto largo se ajuste */
        }
        .chat-details-modal p strong {
            color: var(--text-secondary);
            margin-right: 5px;
        }


        /* Responsive adjustments */
        @media (max-width: 768px) {
            .whatsapp-container {
                flex-direction: column; /* Apila los paneles en móvil */
            }

            .sidebar {
                flex: 0 0 100%; /* Ocupa todo el ancho en pantallas pequeñas */
                max-width: none; /* Elimina el límite de ancho */
                border-right: none;
                height: 100%; /* Ocupa toda la altura si está visible */
            }

            .main-chat {
                flex: 0 0 100%; /* Ocupa todo el ancho en pantallas pequeñas */
                height: 100%; /* Ocupa toda la altura si está visible */
                position: absolute; /* Para que se superponga al sidebar */
                top: 0;
                left: 0;
                width: 100%;
                z-index: 50; /* Asegura que esté por encima del sidebar cuando está activo */
            }

            /* Mostrar/ocultar elementos en móvil */
            .sidebar.hidden-mobile {
                display: none;
            }

            .main-chat.hidden-mobile {
                display: none;
            }

            .main-chat-header .back-button {
                display: block; /* Mostrar el botón de retroceso en móvil */
            }
        }
    </style>
</head>
<body>
    <div class="whatsapp-container">
        <!-- Panel izquierdo: Lista de chats y botón flotante -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="profile-area">
                    <div class="profile-pic-display">
                        <img id="main-profile-pic-display" src="https://placehold.co/40x40/ccc/fff?text=P" alt="Profile">
                    </div>
                    <div class="username-info">
                        <div class="username-display" data-placeholder="Tu Nombre">Tu Nombre</div>
                        <div class="user-status-display" data-placeholder="Estado"></div>
                    </div>
                </div>
                <div class="icons">
                    <i class="fas fa-ellipsis-v" id="sidebarHeaderMenuIcon"></i> <!-- Icono de menú -->
                    <!-- Menú desplegable del header del sidebar -->
                    <div class="header-dropdown-menu hidden" id="sidebarHeaderDropdown">
                        <div class="dropdown-item" id="editProfileOption">Editar perfil</div>
                        <div class="dropdown-item" id="toggleThemeOption">Modo Claro/Oscuro</div>
                    </div>
                </div>
            </div>
            <!-- Eliminada la barra de búsqueda -->
            <div class="chat-list">
                <!-- Los chats se añadirán dinámicamente aquí -->
            </div>
            <!-- Botón flotante para crear nuevo chat -->
            <div class="create-chat-button">
                <i class="fas fa-plus"></i>
            </div>
        </div>

        <!-- Panel derecho: Área de chat principal o pantalla de bienvenida -->
        <div class="main-chat" id="main-chat">
            <div class="main-chat-header hidden"> <!-- Oculto por defecto cuando no hay chat seleccionado -->
                <div class="contact-info">
                    <i class="fas fa-arrow-left back-button" id="backButton"></i> <!-- Botón de retroceso para móvil -->
                    <!-- Imagen de perfil del chat en la cabecera -->
                    <img id="mainChatProfilePic" src="https://placehold.co/40x40/ccc/fff?text=P" alt="Profile" class="profile-pic-header">
                    <div>
                        <div class="name"></div> <!-- Nombre del chat activo -->
                        <div class="status"></div>
                    </div>
                </div>
                <div class="icons">
                    <!-- <i class="fas fa-search hidden"></i> --> <!-- Oculto inicialmente -->
                    <i class="fas fa-ellipsis-v" id="mainChatHeaderMenuIcon"></i> <!-- Icono de menú del chat principal -->
                    <!-- Menú desplegable del header del chat principal -->
                    <div class="chat-header-dropdown-menu hidden" id="mainChatHeaderDropdown">
                        <div class="dropdown-item" id="clearChatOption">Limpiar chat</div>
                        <div class="dropdown-item delete-option" id="deleteChatOption">Borrar chat completo</div>
                    </div>
                </div>
            </div>

            <!-- Pantalla de bienvenida / espera -->
            <div class="welcome-screen" id="welcome-screen">
                <i class="fas fa-robot welcome-icon"></i> <!-- Icono de robot para IA -->
                <h2>WhatsAI</h2> <!-- Título cambiado a WhatsAI -->
                <p>¡Hola! Soy WhatsAI, tu compañero de chat inteligente.</p>
                <p>Estoy aquí para escucharte, conversar y hacerte compañía siempre que lo necesites.</p>
                <p>¡Inicia un nuevo chat para empezar a hablar!</p>
            </div>

            <!-- Área de mensajes (oculta inicialmente) -->
            <div class="message-area hidden" id="message-area">
                <!-- No hay mensajes predeterminados aquí -->
            </div>

            <!-- Pie de página del chat (oculto inicialmente) -->
            <div class="main-chat-footer hidden" id="main-chat-footer">
                <div class="icons">
                    <i class="fas fa-paperclip" id="attachButton"></i> <!-- Adjuntar (ahora solo muestra aviso) -->
                </div>
                <div class="input-box">
                    <textarea id="message-input" rows="1" placeholder="Escribe un mensaje aquí"></textarea>
                </div>
                <div class="send-button" id="send-button">
                    <i class="fas fa-paper-plane"></i> <!-- Icono de enviar (siempre) -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modales -->
    <!-- Modal para Crear Nuevo Chat -->
    <div class="modal-overlay hidden" id="newChatModalOverlay">
        <div class="new-chat-modal">
            <i class="fas fa-times close-modal" id="closeNewChatModal"></i>
            <h3>Crear Nuevo Chat</h3>

            <div class="modal-profile-pic-upload">
                <img id="modal-profile-pic-display" src="https://placehold.co/80x80/ccc/fff?text=P" alt="Foto de Perfil">
                <input type="file" id="modal-profile-pic-input" accept="image/*">
            </div>

            <div class="modal-field">
                <label for="new-chat-name">Nombre del Chat / Contacto (máx. 150 caracteres)</label>
                <input type="text" id="new-chat-name" maxlength="150" placeholder="Ej: Amigo, Familia, Trabajo">
            </div>

            <div class="modal-field">
                <label for="new-chat-description">Descripción (personalidad, relación, máx. 3000 caracteres)</label>
                <textarea id="new-chat-description" maxlength="3000" placeholder="Ej: Mi mejor amigo, nos conocemos desde la infancia. Le encanta la música rock."></textarea>
            </div>

            <div class="modal-field">
                <label for="new-chat-relationship">Relación con la IA</label>
                <select id="new-chat-relationship">
                    <option value="amigo">Amigo/a</option>
                    <option value="novio">Novio/a</option>
                    <option value="hermano">Hermano/a</option>
                    <option value="familiar">Familiar</option>
                    <option value="colega">Colega</option>
                    <option value="mentor">Mentor/a</option>
                    <option value="asistente">Asistente</option>
                    <option value="otro">Otro</option>
                </select>
            </div>

            <div class="modal-buttons">
                <button class="cancel-btn" id="cancelNewChat">Cancelar</button>
                <button class="create-btn" id="createNewChat">Crear</button>
            </div>
        </div>
    </div>

    <!-- Modal para Editar Perfil (Foto y Nombre) -->
    <div class="modal-overlay hidden" id="editProfileModalOverlay">
        <div class="edit-profile-modal">
            <i class="fas fa-times close-modal" id="closeEditProfileModal"></i>
            <h3>Editar Perfil</h3>

            <div class="modal-profile-pic-upload">
                <img id="edit-profile-pic-display" src="https://placehold.co/80x80/ccc/fff?text=P" alt="Foto de Perfil">
                <input type="file" id="edit-profile-pic-input" accept="image/*">
            </div>

            <div class="modal-field">
                <label for="edit-username">Tu Nombre (máx. 150 caracteres)</label>
                <input type="text" id="edit-username" maxlength="150" placeholder="Tu Nombre">
            </div>

            <div class="modal-field">
                <label for="edit-user-status">Tu Estado (máx. 50 caracteres)</label>
                <input type="text" id="edit-user-status" maxlength="50" placeholder="Ej: Disponible, En el trabajo, En el gimnasio">
            </div>

            <div class="modal-buttons">
                <button class="cancel-btn" id="cancelEditProfile">Cancelar</button>
                <button class="accept-btn" id="saveEditProfile">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmación de Borrado (para chat item y ahora para chat completo) -->
    <div class="modal-overlay hidden" id="confirmDeleteModalOverlay">
        <div class="confirm-modal-content">
            <h3 id="confirmDeleteTitle">¿Borrar este chat?</h3>
            <p id="confirmDeleteMessage">¿Estás seguro de que deseas eliminar este chat? Esta acción no se puede deshacer.</p>
            <div class="modal-buttons">
                <button class="cancel-btn" id="cancelDelete">Cancelar</button>
                <button class="create-btn delete-confirm-btn" id="confirmDeleteBtn">Borrar</button>
            </div>
        </div>
    </div>

    <!-- Nuevo Modal para "Pronto se añadirá esta función" -->
    <div class="modal-overlay hidden" id="featureComingSoonModalOverlay">
        <div class="feature-coming-soon-modal">
            <i class="fas fa-times close-modal" id="closeFeatureComingSoonModal"></i>
            <h3>Función Próximamente</h3>
            <p>¡Estupendo! Pronto podrás adjuntar fotos y otros archivos. ¡Mantente atento a las actualizaciones!</p>
            <div class="modal-buttons">
                <button class="accept-btn" id="okFeatureComingSoon">Entendido</button>
            </div>
        </div>
    </div>

    <!-- Modal de Consentimiento de Cookies -->
    <div class="modal-overlay hidden" id="cookieConsentModalOverlay">
        <div class="cookie-consent-modal">
            <h3>Consentimiento de Cookies</h3>
            <p>Esta aplicación utiliza el almacenamiento local de tu navegador para guardar tus chats y preferencias. Al hacer clic en "Aceptar", consientes el uso de esta funcionalidad.</p>
            <div class="modal-buttons">
                <button class="accept-btn" id="acceptCookieConsent">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Modal de Detalles del Chat -->
    <div class="modal-overlay hidden" id="chatDetailsModalOverlay">
        <div class="chat-details-modal">
            <i class="fas fa-times close-modal" id="closeChatDetailsModal"></i>
            <h3 id="chatDetailsName"></h3>
            <div class="modal-profile-pic-upload">
                <img id="chatDetailsPic" src="" alt="Foto de Perfil del Chat">
            </div>
            <p><strong>Descripción:</strong> <span id="chatDetailsDescription"></span></p>
            <p><strong>Relación:</strong> <span id="chatDetailsRelationship"></span></p>
            <div class="modal-buttons">
                <button class="accept-btn" id="okChatDetails">Cerrar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Constantes y elementos del DOM
            const APP_TITLE = "WhatsAI"; // Nombre de la aplicación
            document.title = APP_TITLE; // Título inicial de la pestaña del navegador

            const sidebar = document.getElementById('sidebar');
            const mainChat = document.getElementById('main-chat');
            const welcomeScreen = document.getElementById('welcome-screen');
            const messageArea = document.getElementById('message-area');
            const mainChatFooter = document.getElementById('main-chat-footer');
            const backButton = document.getElementById('backButton');
            const messageInput = document.getElementById('message-input'); // Ahora es un textarea
            const sendButton = document.getElementById('send-button');
            const createChatBtn = document.querySelector('.create-chat-button');
            const mainChatHeader = document.querySelector('.main-chat-header'); // Referencia al header principal del chat
            const mainChatHeaderContactInfo = mainChatHeader.querySelector('.contact-info'); // Área clickeable para detalles

            const chatList = document.querySelector('.chat-list');
            let chatItems = document.querySelectorAll('.chat-item');
            const mainChatHeaderName = document.querySelector('.main-chat-header .contact-info .name');
            const mainChatHeaderStatus = document.querySelector('.main-chat-header .contact-info .status');
            const mainChatHeaderIcons = document.querySelectorAll('.main-chat-header .icons i');
            const mainChatProfilePic = document.getElementById('mainChatProfilePic'); // Nueva referencia a la imagen de perfil en el header del chat

            // Elementos de la cabecera del sidebar
            const mainProfilePicDisplay = document.getElementById('main-profile-pic-display');
            const usernameDisplay = document.querySelector('.username-display');
            const userStatusDisplay = document.querySelector('.user-status-display'); // Nuevo elemento para el estado
            const sidebarHeaderMenuIcon = document.getElementById('sidebarHeaderMenuIcon');
            const sidebarHeaderDropdown = document.getElementById('sidebarHeaderDropdown');
            const editProfileOption = document.getElementById('editProfileOption');
            const toggleThemeOption = document.getElementById('toggleThemeOption'); // Opción de modo claro/oscuro

            // Elementos del modal de nuevo chat
            const newChatModalOverlay = document.getElementById('newChatModalOverlay');
            const closeNewChatModalBtn = document.getElementById('closeNewChatModal');
            const modalProfilePicInput = document.getElementById('modal-profile-pic-input');
            const modalProfilePicDisplay = document.getElementById('modal-profile-pic-display');
            const newChatNameInput = document.getElementById('new-chat-name');
            const newChatDescriptionInput = document.getElementById('new-chat-description');
            const newChatRelationshipInput = document.getElementById('new-chat-relationship');
            const cancelNewChatBtn = document.getElementById('cancelNewChat');
            const createNewChatBtnModal = document.getElementById('createNewChat');

            // Elementos del modal de edición de perfil
            const editProfileModalOverlay = document.getElementById('editProfileModalOverlay');
            const closeEditProfileModalBtn = document.getElementById('closeEditProfileModal');
            const editProfilePicInput = document.getElementById('edit-profile-pic-input');
            const editProfilePicDisplay = document.getElementById('edit-profile-pic-display');
            const editUsernameInput = document.getElementById('edit-username');
            const editUserStatusInput = document.getElementById('edit-user-status'); // Nuevo input para el estado
            const cancelEditProfileBtn = document.getElementById('cancelEditProfile');
            const saveEditProfileBtn = document.getElementById('saveEditProfile');

            // Elementos del modal de confirmación de borrado
            const confirmDeleteModalOverlay = document.getElementById('confirmDeleteModalOverlay');
            const confirmDeleteTitle = document.getElementById('confirmDeleteTitle');
            const confirmDeleteMessage = document.getElementById('confirmDeleteMessage');
            const cancelDeleteBtn = document.getElementById('cancelDelete');
            const confirmDeleteBtnElement = document.getElementById('confirmDeleteBtn');
            let chatItemToDelete = null;
            let currentDeleteAction = null; // 'chatItem' o 'fullChat'

            // Elementos para el aviso de "Pronto disponible"
            const attachButton = document.getElementById('attachButton'); // El icono del clip
            const featureComingSoonModalOverlay = document.getElementById('featureComingSoonModalOverlay');
            const closeFeatureComingSoonModal = document.getElementById('closeFeatureComingSoonModal');
            const okFeatureComingSoonBtn = document.getElementById('okFeatureComingSoon');

            // Elementos del menú de la cabecera del chat principal
            const mainChatHeaderMenuIcon = document.getElementById('mainChatHeaderMenuIcon');
            const mainChatHeaderDropdown = document.getElementById('mainChatHeaderDropdown');
            const clearChatOption = document.getElementById('clearChatOption');
            const deleteChatOption = document.getElementById('deleteChatOption');

            // Elementos del modal de consentimiento de cookies
            const cookieConsentModalOverlay = document.getElementById('cookieConsentModalOverlay');
            const acceptCookieConsentBtn = document.getElementById('acceptCookieConsent');

            // Elementos del modal de detalles del chat
            const chatDetailsModalOverlay = document.getElementById('chatDetailsModalOverlay');
            const closeChatDetailsModalBtn = document.getElementById('closeChatDetailsModal');
            const chatDetailsName = document.getElementById('chatDetailsName');
            const chatDetailsPic = document.getElementById('chatDetailsPic');
            const chatDetailsDescription = document.getElementById('chatDetailsDescription');
            const chatDetailsRelationship = document.getElementById('chatDetailsRelationship');
            const okChatDetailsBtn = document.getElementById('okChatDetails');


            // Variable para almacenar los datos de los chats (array de objetos de chat)
            let chatData = []; 
            // Objeto para almacenar los datos del perfil del usuario
            let userProfile = {
                name: 'Tu Nombre',
                status: '',
                pic: 'https://placehold.co/40x40/ccc/fff?text=P',
                picIsPlaceholder: true, // Para saber si la imagen es un placeholder SVG
                picBgColor: '#ccc' // Color de fondo si es placeholder
            };
            let currentActiveChatId = null;

            // --- Funciones de Utilidad ---

            /**
             * Genera un color hexadecimal aleatorio.
             * @returns {string} Color hexadecimal (ej. "#RRGGBB").
             */
            const getRandomColor = () => {
                const letters = '0123456789ABCDEF';
                let color = '#';
                for (let i = 0; i < 6; i++) {
                    color += letters[Math.floor(Math.random() * 16)];
                }
                return color;
            };

            /**
             * Genera una URL de datos SVG para una imagen de perfil con una letra y color aleatorio.
             * @param {string} letter - La letra a mostrar.
             * @param {string} bgColor - El color de fondo.
             * @returns {string} La URL de datos SVG.
             */
            const generateSvgProfilePic = (letter, bgColor) => {
                return `data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='50' fill='${bgColor.replace('#', '%23')}'/%3E%3Ctext x='50%25' y='50%25' font-size='60' font-family='Helvetica Neue, Helvetica, Arial, sans-serif' text-anchor='middle' dominant-baseline='central' fill='%23FFFFFF'%3E${letter.toUpperCase()}%3C/text%3E%3C/svg%3E`;
            };

            /**
             * Lee un archivo de imagen y lo muestra en un elemento <img>.
             * @param {HTMLInputElement} inputElement - El input de tipo file.
             * @param {HTMLImageElement} imgElement - El elemento <img> donde mostrar la imagen.
             * @returns {Promise<object>} Una promesa que resuelve con un objeto { src, isPlaceholder, bgColor }
             */
            const readAndDisplayImage = (inputElement, imgElement) => {
                return new Promise((resolve) => {
                    if (inputElement.files && inputElement.files[0]) {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            imgElement.src = e.target.result;
                            imgElement.classList.remove('placeholder');
                            imgElement.style.backgroundColor = '';
                            resolve({ src: e.target.result, isPlaceholder: false, bgColor: '' });
                        };
                        reader.readAsDataURL(inputElement.files[0]);
                    } else {
                        // If no file selected, revert to default placeholder logic
                        const randomBgColor = getRandomColor();
                        const defaultSrc = generateSvgProfilePic('P', randomBgColor);
                        imgElement.src = defaultSrc;
                        imgElement.classList.add('placeholder');
                        imgElement.style.backgroundColor = randomBgColor;
                        resolve({ src: defaultSrc, isPlaceholder: true, bgColor: randomBgColor });
                    }
                });
            };

            /**
             * Trunca un mensaje a una longitud máxima y añade puntos suspensivos si es necesario.
             * @param {string} message - El mensaje a truncar.
             * @param {number} maxLength - La longitud máxima deseada.
             * @returns {string} El mensaje truncado.
             */
            const truncateMessage = (message, maxLength = 20) => {
                if (!message) return '';
                return message.length > maxLength ? message.substring(0, maxLength) + '...' : message;
            };

            /**
             * Actualiza la visualización del estado de un mensaje (ticks).
             * @param {HTMLElement} messageElement - El elemento DOM de la burbuja de mensaje.
             * @param {string} status - El estado del mensaje ('sent', 'received', 'read').
             */
            const updateMessageStatusDisplay = (messageElement, status) => {
                let statusIcon = messageElement.querySelector('.message-status');
                if (!statusIcon) {
                    const timeElement = messageElement.querySelector('.message-time');
                    statusIcon = document.createElement('i');
                    statusIcon.classList.add('fas', 'message-status');
                    timeElement.appendChild(statusIcon);
                }

                statusIcon.classList.remove('fa-check', 'fa-check-double', 'read'); // Reset classes
                if (status === 'sent') {
                    statusIcon.classList.add('fa-check');
                } else if (status === 'received') {
                    statusIcon.classList.add('fa-check-double');
                } else if (status === 'read') {
                    statusIcon.classList.add('fa-check-double', 'read');
                }
            };

            /**
             * Renderiza una burbuja de mensaje en el área de chat.
             * @param {object} message - El objeto mensaje.
             * @param {HTMLElement} targetArea - El elemento DOM donde añadir el mensaje.
             */
            const renderMessageBubble = (message, targetArea) => {
                if (message.type === 'text') {
                    const newMessageBubble = document.createElement('div');
                    newMessageBubble.classList.add('message-bubble', message.sender);
                    newMessageBubble.innerHTML = `
                        <div class="message-text">${message.content}</div>
                        <div class="message-time">${message.time}</div>
                    `;
                    targetArea.appendChild(newMessageBubble);

                    if (message.sender === 'sent') {
                        // Inicializa el estado del tick
                        updateMessageStatusDisplay(newMessageBubble, message.status || 'sent');
                    }
                } else if (message.type === 'image') {
                    const newImageBubble = document.createElement('div');
                    newImageBubble.classList.add('image-bubble', message.sender);
                    newImageBubble.innerHTML = `
                        <img src="${message.imageUrl}" alt="Imagen enviada">
                        ${message.message ? `<div class="message-text">${message.message}</div>` : ''}
                        <div class="message-time">${message.time}</div>
                    `;
                    targetArea.appendChild(newImageBubble);

                    if (message.sender === 'sent') {
                        updateMessageStatusDisplay(newImageBubble, message.status || 'sent');
                    }
                }
                targetArea.scrollTop = targetArea.scrollHeight; // Asegurarse de que se desplaza al final
            };

            /**
             * Actualiza la visualización de un elemento de chat en la lista (último mensaje, contador de no leídos).
             * @param {string} chatId - El ID del chat a actualizar.
             */
            const updateChatItemDisplay = (chatId) => {
                const chat = chatData.find(c => c.id === chatId);
                if (!chat) return;

                const chatItemElement = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
                if (!chatItemElement) return;

                const lastMessageElement = chatItemElement.querySelector('.chat-info .last-message');
                let unreadBadgeElement = chatItemElement.querySelector('.unread-badge');
                const lastMessageTimeElement = chatItemElement.querySelector('.chat-time .last-message-time');

                const lastMessage = chat.messages.length > 0 ? chat.messages[chat.messages.length - 1] : null;

                // Actualizar el último mensaje truncado
                if (lastMessage) {
                    lastMessageElement.textContent = truncateMessage(lastMessage.type === 'text' ? lastMessage.content : (lastMessage.message || 'Archivo adjunto'));
                    lastMessageTimeElement.textContent = lastMessage.time; // Mostrar la hora del último mensaje
                } else {
                    lastMessageElement.textContent = truncateMessage(chat.description); // Si no hay mensajes, mostrar la descripción
                    lastMessageTimeElement.textContent = ''; // No hay hora si no hay mensajes
                }

                // Actualizar el contador de mensajes no leídos
                if (chat.unreadCount > 0) { // Always show if unreadCount > 0, regardless of active chat
                    if (!unreadBadgeElement) {
                        const timeContainer = chatItemElement.querySelector('.chat-time');
                        unreadBadgeElement = document.createElement('div');
                        unreadBadgeElement.classList.add('unread-badge');
                        timeContainer.appendChild(unreadBadgeElement);
                    }
                    unreadBadgeElement.textContent = chat.unreadCount;
                    unreadBadgeElement.style.display = 'flex'; // Asegurarse de que esté visible
                } else {
                    if (unreadBadgeElement) {
                        unreadBadgeElement.style.display = 'none'; // Ocultar si no hay no leídos
                    }
                }
            };

            /**
             * Cambia el chat activo, carga sus mensajes y gestiona la visibilidad de los paneles.
             * @param {HTMLElement|null} selectedChatElement - El elemento HTML del chat seleccionado o null para la pantalla de bienvenida.
             */
            const setActiveChat = (selectedChatElement) => {
                chatItems.forEach(item => item.classList.remove('active'));

                if (selectedChatElement) {
                    const newChatId = selectedChatElement.dataset.chatId;

                    selectedChatElement.classList.add('active');
                    welcomeScreen.classList.add('hidden');
                    messageArea.classList.remove('hidden');
                    mainChatFooter.classList.remove('hidden');
                    mainChatHeader.classList.remove('hidden'); // Mostrar el header del chat
                    mainChatHeaderIcons.forEach(icon => icon.classList.remove('hidden'));

                    currentActiveChatId = newChatId;

                    const currentChat = chatData.find(c => c.id === newChatId);
                    if (!currentChat) {
                        console.error('Error: Chat no encontrado en chatData al intentar activarlo.');
                        return;
                    }

                    // Reiniciar contador de no leídos y actualizar display
                    currentChat.unreadCount = 0;
                    updateChatItemDisplay(newChatId);
                    saveAppData(); // Guardar cambios en unreadCount

                    mainChatHeaderName.textContent = currentChat.name.replace('(du)', '').trim();
                    mainChatHeaderStatus.textContent = 'en línea';
                    mainChatHeaderStatus.classList.remove('typing');
                    
                    // Actualizar la imagen de perfil en el header del chat
                    mainChatProfilePic.src = currentChat.pic;
                    // Si la imagen es un SVG placeholder, añadir la clase 'placeholder' y color de fondo
                    if (currentChat.picIsPlaceholder) {
                        mainChatProfilePic.classList.add('placeholder');
                        mainChatProfilePic.style.backgroundColor = currentChat.picBgColor;
                    } else {
                        mainChatProfilePic.classList.remove('placeholder');
                        mainChatProfilePic.style.backgroundColor = '';
                    }
                    mainChatProfilePic.alt = currentChat.name;

                    messageArea.innerHTML = ''; // Limpiar mensajes anteriores
                    currentChat.messages.forEach(msg => {
                        renderMessageBubble(msg, messageArea);
                    });
                    messageArea.scrollTop = messageArea.scrollHeight;

                    // Actualizar el título de la pestaña del navegador
                    document.title = `${currentChat.name} - ${APP_TITLE}`;

                    if (window.innerWidth <= 768) {
                        sidebar.classList.add('hidden-mobile');
                        mainChat.classList.remove('hidden-mobile');
                    }

                } else {
                    currentActiveChatId = null;
                    welcomeScreen.classList.remove('hidden');
                    messageArea.classList.add('hidden');
                    mainChatFooter.classList.add('hidden');
                    mainChatHeader.classList.add('hidden'); // Ocultar el header del chat
                    mainChatHeaderIcons.forEach(icon => icon.classList.add('hidden'));

                    // Restaurar la imagen de perfil del header a un placeholder o ocultarla
                    mainChatProfilePic.src = "https://placehold.co/40x40/ccc/fff?text=P";
                    mainChatProfilePic.alt = "Profile";
                    mainChatProfilePic.classList.remove('placeholder'); // Asegurarse de quitar la clase placeholder
                    mainChatProfilePic.style.backgroundColor = ''; // Limpiar color de fondo

                    mainChatHeaderName.textContent = ''; 
                    mainChatHeaderStatus.textContent = '';
                    mainChatHeaderStatus.classList.remove('typing');

                    // Restaurar el título de la pestaña del navegador
                    document.title = APP_TITLE;

                    if (window.innerWidth <= 768) {
                        sidebar.classList.remove('hidden-mobile');
                        mainChat.classList.add('hidden-mobile');
                    }
                }
            };

            /**
             * Añade listeners de eventos a un nuevo elemento de chat.
             * @param {HTMLElement} item - El elemento HTML del chat.
             */
            const addChatItemClickListener = (item) => {
                item.addEventListener('click', (event) => {
                    if (!event.target.closest('.chat-dropdown-menu') && !event.target.closest('.chat-menu-icon')) {
                        setActiveChat(item);
                    }
                });

                const chatMenuIcon = item.querySelector('.chat-menu-icon');
                const chatDropdownMenu = item.querySelector('.chat-dropdown-menu');

                item.addEventListener('mouseenter', () => {
                    chatMenuIcon.style.opacity = '1';
                    chatMenuIcon.style.visibility = 'visible';
                });

                item.addEventListener('mouseleave', (event) => {
                    if (!chatDropdownMenu.contains(event.relatedTarget)) {
                        chatMenuIcon.style.opacity = '0';
                        chatMenuIcon.style.visibility = 'hidden';
                        chatDropdownMenu.classList.remove('visible');
                    }
                });

                chatMenuIcon.addEventListener('click', (event) => {
                    event.stopPropagation();
                    document.querySelectorAll('.chat-dropdown-menu.visible').forEach(menu => {
                        if (menu !== chatDropdownMenu) {
                            menu.classList.remove('visible');
                        }
                    });
                    sidebarHeaderDropdown.classList.add('hidden');
                    mainChatHeaderDropdown.classList.add('hidden');
                    chatDropdownMenu.classList.toggle('visible');
                });

                const deleteOptionInItem = item.querySelector('.dropdown-item.delete-option');
                if (deleteOptionInItem) {
                    deleteOptionInItem.addEventListener('click', (event) => {
                        event.stopPropagation();
                        chatItemToDelete = item;
                        currentDeleteAction = 'chatItem';
                        confirmDeleteTitle.textContent = '¿Borrar este chat?';
                        confirmDeleteMessage.textContent = '¿Estás seguro de que deseas eliminar este chat? Esta acción no se puede deshacer.';
                        confirmDeleteModalOverlay.classList.remove('hidden');
                        chatDropdownMenu.classList.remove('visible');
                    });
                }
            };

            // Cerrar todos los menús desplegables al hacer clic en cualquier parte del documento
            document.addEventListener('click', (event) => {
                document.querySelectorAll('.chat-dropdown-menu.visible').forEach(menu => {
                    if (!menu.contains(event.target) && !event.target.closest('.chat-menu-icon')) {
                        menu.classList.remove('visible');
                        const chatItem = menu.closest('.chat-item');
                        if (chatItem) {
                            const chatMenuIcon = chatItem.querySelector('.chat-menu-icon');
                            if (chatMenuIcon) {
                                chatMenuIcon.style.opacity = '0';
                                chatMenuIcon.style.visibility = 'hidden';
                            }
                        }
                    }
                });

                if (!sidebarHeaderDropdown.contains(event.target) && event.target !== sidebarHeaderMenuIcon && event.target !== toggleThemeOption) {
                    sidebarHeaderDropdown.classList.add('hidden');
                }

                if (!mainChatHeaderDropdown.contains(event.target) && event.target !== mainChatHeaderMenuIcon) {
                    mainChatHeaderDropdown.classList.add('hidden');
                }
            });

            /**
             * Envía un mensaje de texto a la IA (Google Gemini).
             * Reescrita la función para mejorar la gestión del historial y el prompt de la persona.
             * @param {string} messageText - El mensaje de texto a enviar.
             */
            const sendTextMessageToAI = async (messageText) => {
                const currentChat = chatData.find(c => c.id === currentActiveChatId);
                if (!currentChat) {
                    console.error('Error: No hay chat activo para enviar mensajes a la IA.');
                    return;
                }

                mainChatHeaderStatus.textContent = 'escribiendo...';
                mainChatHeaderStatus.classList.add('typing');

                // Actualizar el estado del último mensaje enviado por el usuario a 'received'
                const lastUserMessageIndex = currentChat.messages.map(m => m.sender).lastIndexOf('sent');
                if (lastUserMessageIndex !== -1) {
                    currentChat.messages[lastUserMessageIndex].status = 'received';
                    const lastMessageBubbleElement = messageArea.children[lastUserMessageIndex];
                    if (lastMessageBubbleElement) {
                        updateMessageStatusDisplay(lastMessageBubbleElement, 'received');
                    }
                }

                try {
                    let chatHistoryForAPI = [];
                    // Construir el prompt de la persona con la descripción y la relación
                    // Añadir el nombre del usuario para que la IA pueda usarlo
                    const personaPrompt = `Eres un asistente de chat. Tu nombre es ${currentChat.name}. Tu relación con el usuario es de ${currentChat.relationship}. Tu personalidad es: ${currentChat.description}. El nombre del usuario es ${userProfile.name}. Intenta llamarlo por su nombre de vez en cuando.`;

                    // Añadir el prompt de la persona al inicio del historial de la API
                    chatHistoryForAPI.push({ role: "user", parts: [{ text: personaPrompt }] });

                    // Añadir todos los mensajes previos al historial para la API
                    // Mapear 'sent' a 'user' y 'received' a 'model'
                    currentChat.messages.forEach(msg => {
                        if (msg.type === 'text') {
                            chatHistoryForAPI.push({ role: msg.sender === 'sent' ? 'user' : 'model', parts: [{ text: msg.content }] });
                        }
                    });

                    // Añadir el mensaje actual del usuario al historial.
                    chatHistoryForAPI.push({ role: "user", parts: [{ text: messageText }] });

                    const payload = {
                        contents: chatHistoryForAPI,
                    };

                    // La clave de API se inyecta automáticamente en el entorno de Canvas si se deja como cadena vacía.
                    const apiKey = "AIzaSyAMFfXic8_vsIuS5uTg0jKxtgBoo_8RzkI"; 
                    console.log('DEBUG: API Key antes de fetch:', apiKey);
                    console.log('DEBUG: Contenido del payload antes de fetch:', JSON.stringify(payload.contents));

                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    console.log('Respuesta de la API (status):', response.status);
                    console.log('Respuesta de la API (statusText):', response.statusText);

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error('Error en la respuesta de la IA (texto):', errorData);
                        const errorMessage = {
                            type: 'text',
                            content: `Lo siento, no pude obtener una respuesta de la IA en este momento. Error: ${response.status} - ${errorData.error?.message || 'Desconocido'}`,
                            time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                            sender: 'received'
                        };
                        currentChat.messages.push(errorMessage);
                        renderMessageBubble(errorMessage, messageArea);
                        messageArea.scrollTop = messageArea.scrollHeight;
                        saveAppData(); // Guardar el error en el chat
                        return; // Sale de la función si hay un error
                    }

                    const result = await response.json();
                    console.log("Respuesta de la API de Gemini (texto):", result);

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        const aiResponseText = result.candidates[0].content.parts[0].text;

                        const aiMessage = {
                            type: 'text',
                            content: aiResponseText,
                            time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                            sender: 'received'
                        };

                        currentChat.messages.push(aiMessage);
                        renderMessageBubble(aiMessage, messageArea);
                        messageArea.scrollTop = messageArea.scrollHeight;

                        // Si el chat no está activo, incrementa el contador de no leídos.
                        if (currentActiveChatId !== currentChat.id) {
                            currentChat.unreadCount++;
                        }
                        updateChatItemDisplay(currentActiveChatId);
                        saveAppData(); // Guardar el nuevo mensaje y el unreadCount

                        // Actualiza el estado del último mensaje enviado por el usuario a 'read'
                        if (lastUserMessageIndex !== -1) {
                            currentChat.messages[lastUserMessageIndex].status = 'read';
                            const lastMessageBubbleElement = messageArea.children[lastUserMessageIndex];
                            if (lastMessageBubbleElement) {
                                updateMessageStatusDisplay(lastMessageBubbleElement, 'read');
                            }
                        }

                    } else {
                        console.error('Error: Estructura de respuesta de Gemini inesperada o vacía (texto).', result);
                        const errorMessage = {
                            type: 'text',
                            content: 'Lo siento, no pude obtener una respuesta de la IA en este momento. La respuesta fue inesperada.',
                            time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                            sender: 'received'
                        };
                        currentChat.messages.push(errorMessage);
                        renderMessageBubble(errorMessage, messageArea);
                        messageArea.scrollTop = messageArea.scrollHeight;
                        saveAppData(); // Guardar el error en el chat
                    }
                } catch (error) {
                    console.error('Error al llamar a la API de Gemini para texto:', error);
                    const errorMessage = {
                        type: 'text',
                        content: `Hubo un error al conectar con la IA. Inténtalo de nuevo. Detalle: ${error.message}`,
                        time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }),
                        sender: 'received'
                    };
                    currentChat.messages.push(errorMessage);
                    renderMessageBubble(errorMessage, messageArea);
                    messageArea.scrollTop = messageArea.scrollHeight;
                    saveAppData(); // Guardar el error en el chat
                } finally {
                    mainChatHeaderStatus.textContent = 'en línea';
                    mainChatHeaderStatus.classList.remove('typing');
                }
            };

            /**
             * Guarda todos los datos de la aplicación (chats y perfil de usuario) en localStorage.
             */
            const saveAppData = () => {
                try {
                    localStorage.setItem('whatsAI_chatData', JSON.stringify(chatData));
                    localStorage.setItem('whatsAI_userProfile', JSON.stringify(userProfile));
                    console.log('Datos de la aplicación (chats y perfil) guardados en localStorage.');
                } catch (e) {
                    console.error('Error al guardar datos de la aplicación en localStorage:', e);
                }
            };

            /**
             * Carga todos los datos de la aplicación (chats y perfil de usuario) desde localStorage.
             * Renderiza los chats y actualiza la visualización del perfil.
             */
            const loadAppData = () => {
                try {
                    const savedChatData = localStorage.getItem('whatsAI_chatData');
                    if (savedChatData) {
                        chatData = JSON.parse(savedChatData);
                        console.log('Datos de chat cargados desde localStorage:', chatData);
                        renderChatList(); // Renderizar la lista de chats
                    }

                    const savedUserProfile = localStorage.getItem('whatsAI_userProfile');
                    if (savedUserProfile) {
                        userProfile = JSON.parse(savedUserProfile);
                        console.log('Datos de perfil de usuario cargados desde localStorage:', userProfile);
                        updateUserProfileDisplay(); // Actualizar la visualización del perfil
                    } else {
                        // Si no hay perfil guardado, inicializar con valores por defecto y guardar
                        updateUserProfileDisplay(); // Display defaults
                        saveAppData(); // Save defaults
                    }
                } catch (e) {
                    console.error('Error al cargar datos de la aplicación desde localStorage:', e);
                    // Si hay un error al cargar (ej. datos corruptos), inicializar con valores por defecto
                    chatData = [];
                    userProfile = {
                        name: 'Tu Nombre',
                        status: '',
                        pic: 'https://placehold.co/40x40/ccc/fff?text=P',
                        picIsPlaceholder: true,
                        picBgColor: '#ccc'
                    };
                    updateUserProfileDisplay(); // Display defaults
                }
            };

            /**
             * Renderiza la lista de chats en el sidebar.
             */
            const renderChatList = () => {
                chatList.innerHTML = ''; // Limpiar la lista actual
                chatData.forEach(chat => {
                    const newChatHtml = `
                        <div class="chat-item" data-chat-id="${chat.id}">
                            <img src="${chat.pic}" alt="${chat.name}" class="profile-pic ${chat.picIsPlaceholder ? 'placeholder' : ''}" ${chat.picIsPlaceholder ? `style="background-color: ${chat.picBgColor};"` : ''}>
                            <div class="chat-info">
                                <div class="name">${chat.name}</div>
                                <div class="last-message"></div>
                            </div>
                            <div class="chat-time">
                                <span class="last-message-time"></span>
                                <div class="unread-badge" style="display: none;">0</div>
                                <i class="fas fa-ellipsis-v chat-menu-icon"></i>
                                <div class="chat-dropdown-menu">
                                    <div class="dropdown-item delete-option">Borrar chat</div>
                                </div>
                            </div>
                        </div>
                    `;
                    chatList.insertAdjacentHTML('beforeend', newChatHtml);
                    const newlyCreatedChatElement = document.querySelector(`[data-chat-id="${chat.id}"]`);
                    addChatItemClickListener(newlyCreatedChatElement);
                    updateChatItemDisplay(chat.id); // Actualizar el display con el último mensaje y no leídos
                });
                chatItems = document.querySelectorAll('.chat-item'); // Actualizar la NodeList
            };

            /**
             * Actualiza la visualización del perfil del usuario en el sidebar.
             */
            const updateUserProfileDisplay = () => {
                mainProfilePicDisplay.src = userProfile.pic;
                if (userProfile.picIsPlaceholder) {
                    mainProfilePicDisplay.classList.add('placeholder');
                    mainProfilePicDisplay.style.backgroundColor = userProfile.picBgColor;
                } else {
                    mainProfilePicDisplay.classList.remove('placeholder');
                    mainProfilePicDisplay.style.backgroundColor = '';
                }
                usernameDisplay.textContent = userProfile.name;
                userStatusDisplay.textContent = userProfile.status;
            };


            /**
             * Comprueba el consentimiento de cookies y muestra el modal si es necesario.
             */
            const checkCookieConsent = () => {
                const consentGiven = localStorage.getItem('cookieConsent');
                if (!consentGiven) {
                    cookieConsentModalOverlay.classList.remove('hidden');
                } else {
                    loadAppData(); // Cargar todos los datos si ya hay consentimiento
                }
            };

            /**
             * Abre el modal de detalles del chat actual.
             */
            const openChatDetailsModal = () => {
                const currentChat = chatData.find(c => c.id === currentActiveChatId);
                if (!currentChat) {
                    console.error('No hay chat activo para mostrar detalles.');
                    return;
                }

                chatDetailsName.textContent = currentChat.name;
                chatDetailsDescription.textContent = currentChat.description;
                chatDetailsRelationship.textContent = currentChat.relationship;
                
                chatDetailsPic.src = currentChat.pic;
                if (currentChat.picIsPlaceholder) {
                    chatDetailsPic.classList.add('placeholder');
                    chatDetailsPic.style.backgroundColor = currentChat.picBgColor;
                } else {
                    chatDetailsPic.classList.remove('placeholder');
                    chatDetailsPic.style.backgroundColor = '';
                }

                chatDetailsModalOverlay.classList.remove('hidden');
            };

            // --- Event Listeners Principales ---

            sendButton.addEventListener('click', () => {
                const messageText = messageInput.value.trim();
                if (!messageText) return;

                // Añadir el mensaje del usuario a chatData y renderizarlo inmediatamente
                const currentTime = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                const newMessage = {
                    type: 'text',
                    content: messageText,
                    time: currentTime,
                    sender: 'sent',
                    status: 'sent' // Initial status for sent messages
                };
                const currentChat = chatData.find(c => c.id === currentActiveChatId);
                if (currentChat) {
                    currentChat.messages.push(newMessage);
                    renderMessageBubble(newMessage, messageArea);
                    messageInput.value = ''; // Limpiar el campo de entrada
                    messageInput.style.height = 'auto'; // Reset height after sending
                    messageArea.scrollTop = messageArea.scrollHeight; // Desplazarse al final
                    updateChatItemDisplay(currentActiveChatId); // Actualizar el elemento de la lista de chats
                    saveAppData(); // Guardar los datos después de enviar un mensaje
                }

                sendTextMessageToAI(messageText);
            });

            // Auto-resize de la barra de texto
            messageInput.addEventListener('input', () => {
                messageInput.style.height = 'auto'; // Reset height to recalculate
                messageInput.style.height = messageInput.scrollHeight + 'px'; // Set height to scrollHeight
            });

            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { // Permite Shift + Enter para nueva línea
                    e.preventDefault(); // Previene el salto de línea por defecto
                    sendButton.click(); // Simular clic en el botón de enviar
                }
            });

            // --- Lógica del Modal de Nuevo Chat ---
            if (createChatBtn) {
                createChatBtn.addEventListener('click', () => {
                    newChatModalOverlay.classList.remove('hidden');
                    // Reset modal profile pic to default placeholder with 'P'
                    const randomBgColor = getRandomColor();
                    const defaultPicSrc = generateSvgProfilePic('P', randomBgColor);
                    modalProfilePicDisplay.src = defaultPicSrc;
                    modalProfilePicDisplay.classList.add('placeholder');
                    modalProfilePicDisplay.style.backgroundColor = randomBgColor;
                    modalProfilePicInput.value = '';
                    newChatNameInput.value = '';
                    newChatDescriptionInput.value = '';
                    newChatRelationshipInput.value = 'amigo';
                });
            } else {
                console.error("Error: El botón para crear chat no fue encontrado en el DOM.");
            }
            
            closeNewChatModalBtn.addEventListener('click', () => {
                newChatModalOverlay.classList.add('hidden');
            });
            cancelNewChatBtn.addEventListener('click', () => {
                newChatModalOverlay.classList.add('hidden');
            });

            modalProfilePicInput.addEventListener('change', async () => {
                const result = await readAndDisplayImage(modalProfilePicInput, modalProfilePicDisplay);
                // No need to save here, will be saved on createNewChatBtnModal click
            });

            createNewChatBtnModal.addEventListener('click', () => {
                const newChatName = newChatNameInput.value.trim();
                const newChatDescription = newChatDescriptionInput.value.trim();
                const newChatRelationship = newChatRelationshipInput.value;
                let newChatPicSrc = modalProfilePicDisplay.src; // Obtener la fuente de la imagen mostrada
                let isPicPlaceholder = modalProfilePicDisplay.classList.contains('placeholder');
                let picBgColor = modalProfilePicDisplay.style.backgroundColor;

                // If no image was selected, generate SVG with first letter and random color
                if (modalProfilePicInput.files.length === 0 && newChatName) {
                    const firstLetter = newChatName.charAt(0);
                    const randomBgColor = getRandomColor();
                    newChatPicSrc = generateSvgProfilePic(firstLetter, randomBgColor);
                    isPicPlaceholder = true;
                    picBgColor = randomBgColor;
                } else if (modalProfilePicInput.files.length === 0 && !newChatName) {
                    // Fallback if no name and no image
                    const randomBgColor = getRandomColor();
                    newChatPicSrc = generateSvgProfilePic('P', randomBgColor);
                    isPicPlaceholder = true;
                    picBgColor = randomBgColor;
                }


                if (newChatName) {
                    const newChatId = Date.now().toString();
                    
                    const newChat = {
                        id: newChatId,
                        name: newChatName,
                        pic: newChatPicSrc, // Guardar la fuente de la imagen
                        picIsPlaceholder: isPicPlaceholder,
                        picBgColor: picBgColor,
                        description: newChatDescription || 'Nuevo chat creado',
                        relationship: newChatRelationship,
                        messages: [],
                        unreadCount: 0,
                    };
                    chatData.push(newChat); // Añadir el nuevo chat al array
                    saveAppData(); // Guardar los datos actualizados

                    const newChatHtml = `
                        <div class="chat-item" data-chat-id="${newChatId}">
                            <img src="${newChatPicSrc}" alt="${newChatName}" class="profile-pic ${isPicPlaceholder ? 'placeholder' : ''}" ${isPicPlaceholder ? `style="background-color: ${picBgColor};"` : ''}>
                            <div class="chat-info">
                                <div class="name">${newChatName}</div>
                                <div class="last-message">${truncateMessage(newChatDescription || 'Nuevo chat creado')}</div>
                            </div>
                            <div class="chat-time">
                                <span class="last-message-time"></span>
                                <div class="unread-badge" style="display: none;">0</div>
                                <i class="fas fa-ellipsis-v chat-menu-icon"></i>
                                <div class="chat-dropdown-menu">
                                    <div class="dropdown-item delete-option">Borrar chat</div>
                                </div>
                            </div>
                        </div>
                    `;
                    chatList.insertAdjacentHTML('beforeend', newChatHtml);

                    chatItems = document.querySelectorAll('.chat-item');
                    const newlyCreatedChatElement = document.querySelector(`[data-chat-id="${newChatId}"]`);

                    addChatItemClickListener(newlyCreatedChatElement);
                    setActiveChat(newlyCreatedChatElement);
                    newChatModalOverlay.classList.add('hidden');
                } else {
                    console.error('Por favor, ingresa un nombre para el chat.');
                }
            });

            // --- Lógica del Modal de Confirmación de Borrado ---
            cancelDeleteBtn.addEventListener('click', () => {
                confirmDeleteModalOverlay.classList.add('hidden');
                chatItemToDelete = null;
                currentDeleteAction = null;
            });

            confirmDeleteBtnElement.addEventListener('click', () => {
                if (currentDeleteAction === 'chatItem' && chatItemToDelete) {
                    const chatIdToDelete = chatItemToDelete.dataset.chatId;
                    chatData = chatData.filter(chat => chat.id !== chatIdToDelete); // Eliminar del array
                    saveAppData(); // Guardar los datos actualizados

                    if (chatItemToDelete.classList.contains('active')) {
                        setActiveChat(null);
                    }
                    chatItemToDelete.remove();
                    chatItems = document.querySelectorAll('.chat-item');
                } else if (currentDeleteAction === 'fullChat' && currentActiveChatId) {
                    const chatElementToRemove = document.querySelector(`.chat-item[data-chat-id="${currentActiveChatId}"]`);
                    if (chatElementToRemove) {
                        chatData = chatData.filter(chat => chat.id !== currentActiveChatId); // Eliminar del array
                        saveAppData(); // Guardar los datos actualizados
                        chatElementToRemove.remove();
                        chatItems = document.querySelectorAll('.chat-item');
                        setActiveChat(null);
                    }
                }
                confirmDeleteModalOverlay.classList.add('hidden');
                chatItemToDelete = null;
                currentDeleteAction = null;
            });

            // --- Lógica para el menú del header del sidebar y edición de perfil ---
            sidebarHeaderMenuIcon.addEventListener('click', (event) => {
                event.stopPropagation();
                document.querySelectorAll('.chat-dropdown-menu.visible').forEach(menu => {
                    menu.classList.remove('visible');
                    const chatItem = menu.closest('.chat-item');
                    if (chatItem) {
                        const chatMenuIcon = chatItem.querySelector('.chat-menu-icon');
                        if (chatMenuIcon) {
                            chatMenuIcon.style.opacity = '0';
                            chatMenuIcon.style.visibility = 'hidden';
                        }
                    }
                });
                mainChatHeaderDropdown.classList.add('hidden');
                sidebarHeaderDropdown.classList.toggle('hidden');
            });

            editProfileOption.addEventListener('click', () => {
                sidebarHeaderDropdown.classList.add('hidden');
                editProfileModalOverlay.classList.remove('hidden');
                // Cargar los datos actuales del perfil en el modal de edición
                editProfilePicDisplay.src = userProfile.pic;
                if (userProfile.picIsPlaceholder) {
                    editProfilePicDisplay.classList.add('placeholder');
                    editProfilePicDisplay.style.backgroundColor = userProfile.picBgColor;
                } else {
                    editProfilePicDisplay.classList.remove('placeholder');
                    editProfilePicDisplay.style.backgroundColor = '';
                }
                editUsernameInput.value = userProfile.name;
                editUserStatusInput.value = userProfile.status;
            });

            closeEditProfileModalBtn.addEventListener('click', () => {
                editProfileModalOverlay.classList.add('hidden');
            });
            cancelEditProfileBtn.addEventListener('click', () => {
                editProfileModalOverlay.classList.add('hidden');
            });

            editProfilePicInput.addEventListener('change', async () => {
                const result = await readAndDisplayImage(editProfilePicInput, editProfilePicDisplay);
                // No need to update userProfile here, it will be done on saveEditProfileBtn click
            });

            saveEditProfileBtn.addEventListener('click', () => {
                const newUsername = editUsernameInput.value.trim();
                const newUserStatus = editUserStatusInput.value.trim();
                let newProfilePicSrc = editProfilePicDisplay.src;
                let newPicIsPlaceholder = editProfilePicDisplay.classList.contains('placeholder');
                let newPicBgColor = editProfilePicDisplay.style.backgroundColor;

                // If no image was selected and name is provided, generate SVG
                if (editProfilePicInput.files.length === 0 && newUsername) {
                    const firstLetter = newUsername.charAt(0);
                    const randomBgColor = getRandomColor();
                    newProfilePicSrc = generateSvgProfilePic(firstLetter, randomBgColor);
                    newPicIsPlaceholder = true;
                    newPicBgColor = randomBgColor;
                } else if (editProfilePicInput.files.length === 0 && !newUsername) {
                    // Fallback if no name and no image
                    const randomBgColor = getRandomColor();
                    newProfilePicSrc = generateSvgProfilePic('P', randomBgColor);
                    newPicIsPlaceholder = true;
                    newPicBgColor = randomBgColor;
                }


                if (newUsername) {
                    userProfile.name = newUsername;
                    userProfile.status = newUserStatus;
                    userProfile.pic = newProfilePicSrc;
                    userProfile.picIsPlaceholder = newPicIsPlaceholder;
                    userProfile.picBgColor = newPicBgColor;

                    updateUserProfileDisplay(); // Actualizar la visualización del perfil
                    saveAppData(); // Guardar los datos del perfil actualizados
                    editProfileModalOverlay.classList.add('hidden');
                } else {
                    console.error('Por favor, ingresa un nombre de usuario.');
                }
            });

            // --- Lógica para el botón de adjuntar (ahora muestra aviso) ---
            attachButton.addEventListener('click', () => {
                featureComingSoonModalOverlay.classList.remove('hidden');
            });

            closeFeatureComingSoonModal.addEventListener('click', () => {
                featureComingSoonModalOverlay.classList.add('hidden');
            });

            okFeatureComingSoonBtn.addEventListener('click', () => {
                featureComingSoonModalOverlay.classList.add('hidden');
            });

            // --- Lógica del botón de retroceso para móvil ---
            backButton.addEventListener('click', () => {
                setActiveChat(null);
            });

            // --- Lógica del menú de la cabecera del chat principal ---
            mainChatHeaderMenuIcon.addEventListener('click', (event) => {
                event.stopPropagation();
                document.querySelectorAll('.chat-dropdown-menu.visible').forEach(menu => {
                    menu.classList.remove('visible');
                    const chatItem = menu.closest('.chat-item');
                    if (chatItem) {
                        const chatMenuIcon = chatItem.querySelector('.chat-menu-icon');
                        if (chatMenuIcon) {
                            chatMenuIcon.style.opacity = '0';
                            chatMenuIcon.style.visibility = 'hidden';
                        }
                    }
                });
                sidebarHeaderDropdown.classList.add('hidden');
                mainChatHeaderDropdown.classList.toggle('hidden');
            });

            clearChatOption.addEventListener('click', () => {
                if (currentActiveChatId) {
                    const currentChat = chatData.find(c => c.id === currentActiveChatId);
                    if (currentChat) {
                        currentChat.messages = [];
                        messageArea.innerHTML = '';
                        mainChatHeaderDropdown.classList.add('hidden');
                        updateChatItemDisplay(currentActiveChatId);
                        saveAppData(); // Guardar los datos después de limpiar el chat
                    }
                }
            });

            deleteChatOption.addEventListener('click', () => {
                if (currentActiveChatId) {
                    currentDeleteAction = 'fullChat';
                    confirmDeleteTitle.textContent = '¿Borrar este chat completo?';
                    confirmDeleteMessage.textContent = '¿Estás seguro de que deseas eliminar este chat y todos sus mensajes? Esta acción no se puede deshacer.';
                    confirmDeleteModalOverlay.classList.remove('hidden');
                    mainChatHeaderDropdown.classList.add('hidden');
                }
            });

            // --- Lógica de Modo Claro/Oscuro ---
            const currentTheme = localStorage.getItem('theme');
            if (currentTheme === 'light-mode') {
                document.body.classList.add('light-mode');
            } else {
                // Por defecto es modo oscuro, asegúrate de que no tenga la clase light-mode
                document.body.classList.remove('light-mode');
            }

            toggleThemeOption.addEventListener('click', () => {
                document.body.classList.toggle('light-mode');
                if (document.body.classList.contains('light-mode')) {
                    localStorage.setItem('theme', 'light-mode');
                } else {
                    localStorage.setItem('theme', 'dark-mode');
                }
                sidebarHeaderDropdown.classList.add('hidden'); // Ocultar el dropdown después de la selección
            });

            // --- Lógica del Modal de Consentimiento de Cookies ---
            acceptCookieConsentBtn.addEventListener('click', () => {
                localStorage.setItem('cookieConsent', 'given');
                cookieConsentModalOverlay.classList.add('hidden');
                loadAppData(); // Cargar chats y perfil una vez que se acepta el consentimiento
            });

            // --- Lógica del Modal de Detalles del Chat ---
            mainChatHeaderContactInfo.addEventListener('click', () => {
                // Solo abrir el modal si hay un chat activo
                if (currentActiveChatId) {
                    openChatDetailsModal();
                }
            });

            closeChatDetailsModalBtn.addEventListener('click', () => {
                chatDetailsModalOverlay.classList.add('hidden');
            });

            okChatDetailsBtn.addEventListener('click', () => {
                chatDetailsModalOverlay.classList.add('hidden');
            });


            // Ajustar la visibilidad inicial de los paneles en función del tamaño de la pantalla
            const adjustLayout = () => {
                if (window.innerWidth <= 768) {
                    if (!document.querySelector('.chat-item.active')) {
                        sidebar.classList.remove('hidden-mobile');
                        mainChat.classList.add('hidden-mobile');
                    } else {
                        sidebar.classList.add('hidden-mobile');
                        mainChat.classList.remove('hidden-mobile');
                    }
                } else {
                    sidebar.classList.remove('hidden-mobile');
                    mainChat.classList.remove('hidden-mobile');
                }
            };

            // Ejecutar al cargar y al redimensionar
            adjustLayout();
            window.addEventListener('resize', adjustLayout);

            // Iniciar la comprobación de consentimiento de cookies al cargar la página
            checkCookieConsent();
        });
    </script>
</body>
</html>
